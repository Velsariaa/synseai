(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6521],{5695:(e,t,n)=>{"use strict";var r=n(8999);n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},6654:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"useMergedRef",{enumerable:!0,get:function(){return a}});let r=n(2115);function a(e,t){let n=(0,r.useRef)(null),a=(0,r.useRef)(null);return(0,r.useCallback)(r=>{if(null===r){let e=n.current;e&&(n.current=null,e());let t=a.current;t&&(a.current=null,t())}else e&&(n.current=o(e,r)),t&&(a.current=o(t,r))},[e,t])}function o(e,t){if("function"!=typeof e)return e.current=t,()=>{e.current=null};{let n=e(t);return"function"==typeof n?n:()=>e(null)}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},9053:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var r=n(5155),a=n(5695),o=n(2115);function s(e){let{children:t,allowedRoles:n}=e,s=(0,a.useRouter)(),[l,c]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{let e=sessionStorage.getItem("access_token"),t=sessionStorage.getItem("role");return e&&t?n.includes(t)?void c(!1):void s.push("/"):void s.push("/login")},[s,n]),(0,r.jsx)(r.Fragment,{children:t})}},9175:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>i});var r=n(5155),a=n(2115),o=n(9053),s=n(9911),l=n(5695),c=n(6766);function i(){return(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading..."}),children:(0,r.jsx)(d,{})})}function d(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),n=null==t?void 0:t.get("id"),i="http://localhost:5000",[d,u]=(0,a.useState)(""),[m,p]=(0,a.useState)(""),[x,h]=(0,a.useState)(!0),[f,g]=(0,a.useState)(""),[b,w]=(0,a.useState)(null),[j,y]=(0,a.useState)(null),[v,N]=(0,a.useState)(!1),[_,S]=(0,a.useState)([]),[E,k]=(0,a.useState)([]),[D,P]=(0,a.useState)(!1),[C,I]=(0,a.useState)(null),[R,A]=(0,a.useState)(""),[F,T]=(0,a.useState)(""),O=(0,a.useRef)(null),[B,U]=(0,a.useState)(!1),[Y,z]=(0,a.useState)(!1),[J,L]=(0,a.useState)(!1),[G,M]=(0,a.useState)([]),V=async()=>{try{let e=sessionStorage.getItem("access_token");if(!e)throw Error("No token found.");let t=await fetch("".concat(i,"/api/department"),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!t.ok)throw Error("Failed to fetch departments: ".concat(t.status));let n=await t.json();console.log("Fetched departments response:",n);let r=n.departments||[];return k(r),r}catch(e){throw console.error("Error fetching departments:",e),e}},H=async()=>{try{console.log("=== Fetching User Department ID ===");let t=sessionStorage.getItem("department_id");if(t&&"null"!==t&&"undefined"!==t){let e=parseInt(t);return console.log("✅ Found department_id in sessionStorage:",e),y(e),e}let n=sessionStorage.getItem("access_token");if(sessionStorage.getItem("user_id"),!n)throw Error("No authentication token found");try{let t=await fetch("".concat(i,"/api/user/profile"),{method:"GET",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"}});if(t.ok){var e;let n=await t.json();if(console.log("Fetched user data from API:",n),n.department_id||(null==(e=n.user)?void 0:e.department_id)){let e=n.department_id||n.user.department_id;return console.log("✅ Found department_id from API:",e),sessionStorage.setItem("department_id",e.toString()),y(e),e}}}catch(e){console.warn("Failed to fetch user data from API:",e)}for(let e of["user","userData","currentUser","userInfo"]){let t=sessionStorage.getItem(e);if(t&&"null"!==t&&"undefined"!==t)try{let n=JSON.parse(t);if(console.log("Found user data in '".concat(e,"':"),n),n&&"object"==typeof n&&void 0!==n.department_id&&null!==n.department_id){console.log("✅ Found department_id in stored user data:",n.department_id);let e=n.department_id;return sessionStorage.setItem("department_id",e.toString()),y(e),e}}catch(t){console.warn("Error parsing '".concat(e,"' data:"),t)}}return console.warn("❌ Department ID not found anywhere"),y(null),null}catch(e){return console.error("Error fetching user department:",e),y(null),null}};(0,a.useEffect)(()=>{H()},[]);let Q=async()=>{if(!C||!n)return void alert("Please select a file first.");if(!v)return void alert("You can only update documents that are currently at your department.");try{let e=sessionStorage.getItem("access_token");if(!e)throw Error("No token found.");let t=new FormData;t.append("file",C);let r=await fetch("".concat(i,"/api/document_setting/update/").concat(n),{method:"POST",headers:{Authorization:"Bearer ".concat(e)},body:t}),a=await r.text();if(console.log("Update response:",a),!r.ok)throw Error("Update failed: ".concat(a));alert("File updated successfully!"),P(!1),I(null),A(""),T(""),window.location.reload()}catch(e){e instanceof Error?(console.error(e.message),alert("Error updating file: ".concat(e.message))):(console.error(e),alert("Error updating file."))}},W=()=>!!b&&b.iteration.indexOf(b.current_location)>=b.iteration.length-1,X=async()=>{if(!n||!b)return void alert("No document setting found.");if(!v)return void alert("You can only push documents that are currently at your department.");if(W())return void alert("This document is already at the final department.");try{U(!0);let e=sessionStorage.getItem("access_token");if(!e)throw Error("No token found.");let t=await fetch("".concat(i,"/api/document_setting/push/").concat(n),{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!t.ok){let e=await t.text();throw Error("Push failed: ".concat(e))}await t.json(),alert("Document pushed to next department successfully!"),window.location.reload()}catch(e){console.error("Error pushing document:",e),alert("Error pushing document: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{U(!1)}},q=async(e,t)=>{if(!n||!b)return void alert("No document setting found.");if(!v)return void alert("You can only update documents that are currently at your department.");try{z("APPROVED"===e),L("REJECTED"===e);let r=sessionStorage.getItem("access_token");if(!r)throw Error("No token found.");let a=await fetch("".concat(i,"/api/document_setting/").concat(n,"/status"),{method:"PATCH",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({status:e,...t&&{rejection_reason:t}})});if(!a.ok){let e=await a.json().catch(()=>({error:"Unknown error"}));throw Error(e.error||"Failed to update document status")}let o=await a.json();w(t=>{var n;return t?{...t,status:(null==(n=o.document_setting)?void 0:n.status)||e,updated_at:new Date().toISOString()}:null}),alert("Document ".concat("APPROVED"===e?"approved":"REJECTED"===e?"rejected":"updated"," successfully!")),window.location.reload()}catch(e){console.error("Error updating document status:",e),alert("Error updating document status: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{z(!1),L(!1)}},K=async()=>{if(!W())return void alert("You can only approve documents at the final department.");await q("APPROVED")},Z=async()=>{if(!W())return void alert("You can only reject documents at the final department.");let e=prompt("Please provide a reason for rejection (optional):");await q("REJECTED",e||"No reason provided")},$=e=>{let t=E.find(t=>t.id===e);return t?t.name:"Department ".concat(e)},ee=async()=>{if(console.log("Refreshing user access..."),await H(),b&&null!==j){let e=b.current_location===j;N(e),console.log("Updated access:",{canInteract:e,currentLocation:b.current_location,userDept:j})}};return((0,a.useEffect)(()=>{if(!n){g("No document setting ID provided"),h(!1);return}(async()=>{try{h(!0),g("");try{await V()}catch(e){console.error("Failed to fetch departments:",e),g("Failed to load departments. Please try again.");return}let e=sessionStorage.getItem("access_token");if(!e)throw Error("No authentication token found. Please log in again.");console.log("Attempting to fetch from:","".concat(i,"/api/document_setting/").concat(n));let t=await fetch("".concat(i,"/api/document_setting/").concat(n),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json",Accept:"application/json"}});if(console.log("Response status:",t.status),!t.ok){let e="Failed to fetch document setting: ".concat(t.status);try{let n=await t.json();e=n.error||n.message||e}catch(n){e="HTTP ".concat(t.status,": ").concat(t.statusText)}throw Error(e)}let r=await t.json();console.log("Received document setting:",r),w(r),u(r.document_name||"Document Setting ".concat(n)),p(r.document_description||"Push the files to the departments for review and approval"),setTimeout(()=>ee(),100)}catch(e){console.error("Error fetching document setting:",e),g(e instanceof Error?e.message:"Failed to fetch document data"),u("Document Setting ".concat(n)),p("Push the files to the departments for review and approval"),M([])}finally{h(!1)}})()},[n,i]),(0,a.useEffect)(()=>{var e,t;b&&E.length>0&&(e=b.iteration,t=b.current_location,E.length&&S(e.map(n=>{let r=E.find(e=>e.id===n),a=e.indexOf(t),o=e.indexOf(n);return{id:n,name:r?r.name:"Department ".concat(n),isActive:n===t,isCompleted:o<a}})),M(b.iteration.map((e,t)=>{let n=$(e);return b.iteration.indexOf(b.current_location),{id:"".concat(b.document_id,"-").concat(e),name:b.document_name,details:b.document_description||"Document file",dateCreated:b.document_created_at?new Date(b.document_created_at).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],isSelected:!1,department:n,downloadUrl:"".concat(i,"/api/document/download_file/").concat(b.document_id),currentLocation:b.current_location,iteration:b.iteration}})))},[b,E]),(0,a.useEffect)(()=>{if(b&&null!==j){let e=b.current_location===j;N(e),console.log("Can user interact:",e,"Current location:",b.current_location,"User dept:",j)}},[b,j]),x)?(0,r.jsx)(o.A,{allowedRoles:["user","employee","admin"],children:(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#B11016] mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-gray-600",children:"Loading document..."})]})})}):(0,r.jsx)(o.A,{allowedRoles:["user","employee","admin"],children:(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center px-4 sm:px-[5%] lg:px-[10%] py-4 sm:py-8",children:[(0,r.jsxs)("div",{className:"relative flex items-center w-full mt-2 mb-4",children:[(0,r.jsxs)("button",{onClick:()=>{let t=sessionStorage.getItem("role");"employee"===t?e.push("/bpidashboard"):"admin"===t?e.push("/admindashboard"):e.push("/dashboard")},className:"absolute left-0 flex items-center text-[#B11016] hover:text-[#800b10] text-sm sm:text-base",children:[(0,r.jsx)(s.QVr,{className:"mr-2"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"Back"})]}),(0,r.jsxs)("div",{className:"text-center w-full",children:[(0,r.jsx)("h1",{className:"text-xl sm:text-2xl lg:text-4xl font-bold text-[#B11016] pb-2 sm:pb-4",children:"Files Pusher"}),(0,r.jsx)("p",{className:"text-sm sm:text-md text-black mb-4 sm:mb-6 px-4",children:"Push the files to the departments for review and approval."}),(0,r.jsx)("div",{className:"mx-2 border-b-[3px] border-[#B11016]"})]})]}),f&&(0,r.jsx)("div",{className:"w-full max-w-6xl mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded",children:(0,r.jsx)("p",{className:"text-sm",children:f})}),null===j&&(0,r.jsx)("div",{className:"w-full max-w-6xl mb-4 p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded",children:(0,r.jsxs)("p",{className:"text-sm",children:[(0,r.jsx)("strong",{children:"Note:"})," Department information not found.",(0,r.jsx)("button",{onClick:ee,className:"ml-2 px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700",children:"Refresh Access"})]})}),!v&&b&&null!==j&&(0,r.jsx)("div",{className:"w-full max-w-6xl mb-4 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded",children:(0,r.jsxs)("p",{className:"text-sm",children:["This document is currently at ",$(b.current_location),". You can only interact with documents that are at your department (Department ID: ",j,").",(0,r.jsx)("button",{onClick:ee,className:"ml-2 px-2 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700",children:"Refresh Access"})]})}),(0,r.jsxs)("div",{className:"w-full max-w-6xl mt-2 grid grid-cols-3 gap-4 text-lg font-semibold text-gray-800",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-[#B11016] font-bold",children:"File Name:"})," ",d]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-[#B11016] font-bold",children:"File Description:"}),"  ",m]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-[#B11016] font-bold",children:"Date created:"})," ",G.length>0?G[0].dateCreated:"N/A"]})]}),(0,r.jsxs)("div",{className:"w-full max-w-6xl mt-6 mb-8",children:[(0,r.jsx)("div",{className:"flex space-x-2 w-full mb-6",children:_.map(e=>(0,r.jsx)("div",{className:"flex-1 h-10 rounded flex items-center justify-center text-xs font-medium transition-colors duration-300 ".concat(e.isCompleted?"bg-[#333333] text-white":e.isActive?"bg-[#B11016] text-white":"bg-gray-300 text-gray-700"),children:(0,r.jsx)("span",{className:"text-center px-1 truncate",title:e.name,children:e.name})},e.id))}),(0,r.jsx)("div",{className:"flex space-x-2 w-full",children:_.map(e=>{let t=G.find(t=>t.department===e.name);return(0,r.jsx)("div",{className:"flex-1 flex flex-col items-center",children:t?(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"cursor-pointer transition-all duration-200 ".concat(t.isSelected?"transform scale-105":""),onClick:()=>{M(e=>e.map(e=>e.id===t.id?{...e,isSelected:!e.isSelected}:e))},children:(0,r.jsx)("div",{className:"relative mb-4",children:(0,r.jsx)(c.default,{src:t.isSelected?"/images/file-card-black.png":(e=>{if(!b)return"/images/file-card.png";let t=b.iteration.indexOf(b.current_location);return b.iteration.findIndex(t=>$(t)===e.department)<t?"/images/file-card-black.png":"/images/file-card.png"})(t),alt:"File Card",width:120,height:144,className:"mx-auto"})})}),(0,r.jsx)("div",{className:"text-xs font-medium text-gray-800 mb-2 truncate px-1",title:t.name,children:t.name}),(0,r.jsxs)("button",{onClick:()=>(e=>{if(!e.downloadUrl)return void alert("No download URL available for this file");console.log("Opening download URL:",e.downloadUrl),window.open(e.downloadUrl,"_blank")})(t),className:"px-3 py-1 bg-[#B11016] text-white text-xs rounded hover:bg-[#800b10] transition-colors flex items-center justify-center mx-auto",disabled:!t.downloadUrl,children:[(0,r.jsx)(s.WCW,{className:"mr-1",size:10}),"Download"]})]}):(0,r.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,r.jsx)(s.t69,{className:"mx-auto text-2xl mb-2 opacity-30"}),(0,r.jsx)("p",{className:"text-xs",children:"No file"})]})},e.id)})}),0===G.length&&(0,r.jsxs)("div",{className:"text-center py-12 text-gray-500",children:[(0,r.jsx)(s.t69,{className:"mx-auto text-4xl mb-4 opacity-30"}),(0,r.jsx)("p",{className:"text-sm sm:text-base",children:"No document available"}),(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:"Document will appear here when loaded"})]})]}),(0,r.jsxs)("div",{className:"w-full max-w-6xl mb-8",children:[(0,r.jsxs)("div",{className:"flex justify-center space-x-4",children:[(0,r.jsx)("button",{onClick:()=>P(!0),disabled:!v||null===j,className:"".concat((W(),"w-full max-w-xs")," px-6 py-3 rounded transition-colors ").concat(v&&null!==j?"bg-[#333333] text-white hover:bg-[#0f0f0f]":"bg-gray-400 text-gray-600 cursor-not-allowed"),children:"Update"}),!W()&&(0,r.jsx)("button",{onClick:X,disabled:!v||B||null===j,className:"w-full max-w-xs px-6 py-3 rounded transition-colors ".concat(v&&!B&&null!==j?"bg-[#B11016] text-white hover:bg-[#800b10]":"bg-gray-400 text-gray-600 cursor-not-allowed"),children:B?"Pushing...":"Push"}),W()&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("button",{onClick:K,disabled:!v||Y||null===j,className:"w-full max-w-xs px-6 py-3 rounded transition-colors flex items-center justify-center ".concat(v&&!Y&&null!==j?"bg-green-600 text-white hover:bg-green-700":"bg-gray-400 text-gray-600 cursor-not-allowed"),children:[(0,r.jsx)(s.CMH,{className:"mr-2"}),Y?"Approving...":"Approve"]}),(0,r.jsxs)("button",{onClick:Z,disabled:!v||J||null===j,className:"w-full max-w-xs px-6 py-3 rounded transition-colors flex items-center justify-center ".concat(v&&!J&&null!==j?"bg-red-600 text-white hover:bg-red-700":"bg-gray-400 text-gray-600 cursor-not-allowed"),children:[(0,r.jsx)(s.QCr,{className:"mr-2"}),J?"Rejecting...":"Reject"]})]})]}),(0,r.jsx)("div",{className:"text-center text-sm text-gray-500 mt-2 space-y-1",children:null===j?(0,r.jsx)("p",{children:"Department information not available. Please check your login setup or refresh access."}):v?W()?(0,r.jsx)("p",{children:"Document has reached the final department. You can update, approve, or reject the document."}):(0,r.jsx)("p",{children:"You can update the document or push it to the next department."}):(0,r.jsx)("p",{children:"You can only interact with documents that are currently at your department."})})]}),D&&(0,r.jsx)("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative mx-4",children:[(0,r.jsx)("button",{onClick:()=>{P(!1),I(null),A(""),T("")},className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700",children:(0,r.jsx)(s.QCr,{})}),(0,r.jsx)("h2",{className:"text-xl font-semibold text-[#B11016] mb-4",children:"Update File"}),(0,r.jsxs)("div",{onDrop:e=>{e.preventDefault(),e.dataTransfer.files&&e.dataTransfer.files.length>0&&I(e.dataTransfer.files[0])},onDragOver:e=>e.preventDefault(),className:"border-2 border-dashed border-red-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-500 transition mb-4",onClick:()=>{var e;return null==(e=O.current)?void 0:e.click()},children:[(0,r.jsx)("img",{src:"/images/uploadicon.png",alt:"Upload Icon",className:"mx-auto h-12 w-12 object-contain"}),(0,r.jsxs)("p",{className:"mt-2 text-gray-600 text-sm",children:["Drag & drop files or"," ",(0,r.jsx)("span",{className:"text-red-600 underline",children:"Browse"})]}),(0,r.jsx)("p",{className:"text-xs text-gray-400",children:"Supported formats: JPEG, PNG, PDF, DOCX"}),(0,r.jsx)("input",{type:"file",accept:".jpeg,.jpg,.png,.pdf,.docx",ref:O,className:"hidden",onChange:e=>{e.target.files&&e.target.files.length>0&&I(e.target.files[0])}})]}),C&&(0,r.jsxs)("div",{className:"mb-4 p-2 border border-green-400 rounded bg-green-50 text-green-700 text-sm",children:["Selected: ",C.name]}),(0,r.jsx)("button",{onClick:Q,disabled:!C,className:"w-full px-4 py-2 bg-[#B11016] text-white rounded hover:bg-[#800b10] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Update File"})]})})]})})}},9906:(e,t,n)=>{Promise.resolve().then(n.bind(n,9175))}},e=>{e.O(0,[6711,5751,8441,5964,7358],()=>e(e.s=9906)),_N_E=e.O()}]);